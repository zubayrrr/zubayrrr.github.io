---
created: 1662710071206
desc: ''
id: sfxbnqwuhznqsk7hvkgsmb0
title: Deploy to EKS Cluster from Jenkins
updated: 1662710100507
---
   
Related::  [jenkins](../devlog/jenkins.md), [kubernetes](../devlog/kubernetes.md)   
   
   
---   
Lets use the cluster we created using `eksctl` in [aws.eks.Create EKS cluster with eksctl](../devlog/aws.eks.Create%20EKS%20cluster%20with%20eksctl.md).   
   
**Overiew**   
   
   
- Install `kubectl` inside Jenkins container.   
- Install `aws-iam-authenticator` inside Jenkins container.   
	- We need this so connect to AWS and K8s(EKS).   
- Create `kubeconfig`  file to connect to the cluster from Jenkins.   
- `aws-iam-authenticator` is installed automatically with `eksctl`.   
- provide AWS  credentials to Jenkins for AWS account authentication.   
   
## Install `kubectl`   
   
   
- SSH into the machine where Jenkins is running.   
- `docker exec -u 0 -it <container-id> bash` to go inside the container.   
- [Install and Set Up kubectl](https://kubernetes.io/docs/tasks/tools/install-kubectl-linux/#install-kubectl-binary-with-curl-on-linux) using [curl](/not_created.md)   
- `chmod +x ./kubectl`   
- `mv ./kubectl /usr/local/bin/kubectl`   
- `kubectl version`   
## Install `aws-iam-authenticator`   
   
   
- [Installing aws-iam-authenticator](https://docs.aws.amazon.com/eks/latest/userguide/install-aws-iam-authenticator.html)   
- You might need to `chmod +x ./aws-iam-authenticator`   
- and `mv ./aws-iam-authenticator  /usr/local/bin`   
   
## Create `kubeconfig`   
   
We don’t have an editor in Docker container so you’ll have to create the `kubeconfig` outside the container(on host) and simply copy it to the container.   
   
`vim config`   
   
```yaml
apiVersion: v1
clusters:
- cluster:
    server: <endpoint-url> # management console > eks cluster > API server endpoint
    certificate-authority-data: <base64-encoded-ca-cert>  # this will be generated by eksctl, check where eksctl was run `cat .kube/config` and its already base64 encoded
  name: kubernetes
contexts:
- context:
    cluster: kubernetes
    user: aws
  name: aws
current-context: aws
kind: Config
preferences: {}
users:
- name: aws
  user:
    exec:
      apiVersion: client.authentication.k8s.io/v1alpha1
      command: aws-iam-authenticator
      args:
        - "token"
        - "-i"
        - "demo-cluster"
```
   
   
Make it available to Jenkins container at default kubeconfig location `~/.kube/config`   
   
`docker exec -u 0 -it <container-id> bash`    
   
`cd ~`   
   
`mkdir .kube`   
   
`exit`   
   
`docker cp config <container-id>:/var/user/.kube`   
   
## Create AWS credentials    
   
We don’t have to use the Admin account. The best practice would be to use AWS IAM User for Jenkins with limited permissions.   
   
In this lab, we’ll use the Admin user.   
   
Create a new credentials in Jenkins with “Secret text” as kind.   
   
![uploading...](30i.m4zh)   
   
The Secret will be the actual key ID.   
   
Create a new credential for secret access key.   
   
![uploading...](7cu.lfga)   
   
and the Secret will be the actual secret key itself.   
   
## Configure Jenkinsfile to deploy to EKS   
   
   
```groovy
#!/usr/bin/env groovy

pipeline {
    agent any
    stages {
        stage('build app') {
            steps {
               script {
                   echo "building the application..."
               }
            }
        }
        stage('build image') {
            steps {
                script {
                    echo "building the docker image..."
                }
            }
        }
        stage('deploy') {
            environment {
               AWS_ACCESS_KEY_ID = credentials('jenkins_aws_access_key_id')
               AWS_SECRET_ACCESS_KEY = credentials('jenkins_aws_secret_access_key')
            }
            steps {
                script {
                   echo 'deploying docker image...'
                   sh 'kubectl create deployment nginx-deployment --image=nginx'
                }
            }
        }
    }
}
```
   
   
Find the finished code at [zubayrrr / java-maven-app · GitLab](https://gitlab.com/zubayrrr/java-maven-app/-/tree/deploy-on-k8s)   
   
## Execute Jenkins Pipeline   
   
Create a new pipeline and configure the branch that you want to deploy from.